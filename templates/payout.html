<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Request Payout – SLITO EX</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabaseUrl = 'https://jjcyzarilxcccmhvnzhy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqY3l6YXJpbHhjY2NtaHZuemh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMDYzMDYsImV4cCI6MjA2NzU4MjMwNn0.HrgEKPGvqHuViRzNP-o7Ta7IdPp1wrDDRNFXeoCE25I';
    window.supabase = createClient(supabaseUrl, supabaseKey);
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; background: linear-gradient(140deg, #f6fbff 0%, #d6f2ff 50%, #f3fcff 100%); padding: 20px; }
    .container { max-width: 500px; margin: 0 auto; background: white; padding: 24px; border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
    h1 { font-size: 24px; color:#1596c5; margin-bottom:16px; text-align:center; }
    .form-field { margin-bottom: 16px; }
    .form-field label { display:block; margin-bottom:4px; color:#2993c7; font-weight:600; }
    .text-input, .select-input { width:100%; padding:10px 14px; border:1px solid #cbe6f5; border-radius:8px; font-size:14px; }
    .btn { padding:12px 24px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; display:inline-block; }
    .btn-primary { background:#32cfff; color:white; }
    .btn-primary:hover { background:#159aff; }
    .message { margin-top:14px; font-weight:600; color:#107d59; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Request Payout</h1>
    <div id="authMessage" style="color:red; margin-bottom:10px; display:none;"></div>
    <form id="payoutForm">
      <div class="form-field">
        <label for="amount">Amount (EUR)</label>
        <input id="amount" name="amount" type="number" step="0.01" min="0" class="text-input" required>
      </div>
      <div class="form-field">
        <label>Payout Method</label>
        <select id="method" class="select-input" required>
          <option value="paypal">PayPal</option>
          <option value="card">Credit Card</option>
        </select>
      </div>
      <!-- PayPal details -->
      <div class="form-field" id="paypalFields">
        <label for="paypalEmail">PayPal Email</label>
        <input id="paypalEmail" name="paypalEmail" type="email" class="text-input">
      </div>
      <!-- Card details -->
      <div id="cardFields" style="display:none;">
        <div class="form-field">
          <label for="cardName">Cardholder Name</label>
          <input id="cardName" type="text" class="text-input">
        </div>
        <div class="form-field">
          <label for="cardNumber">Card Number</label>
          <input id="cardNumber" type="text" class="text-input" maxlength="19" placeholder="•••• •••• •••• ••••">
        </div>
        <div class="form-field" style="display:flex; gap:10px;">
          <div style="flex:1;">
            <label for="cardExp">Expiry (MM/YY)</label>
            <input id="cardExp" type="text" class="text-input" placeholder="MM/YY" maxlength="5">
          </div>
          <div style="flex:1;">
            <label for="cardCVC">CVC</label>
            <input id="cardCVC" type="text" class="text-input" maxlength="4" placeholder="•••">
          </div>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Submit Request</button>
    </form>
    <div id="successMessage" class="message" style="display:none;">Your payout request has been submitted.</div>
  </div>
  <script>
    const methodSelect = document.getElementById('method');
    const paypalFields = document.getElementById('paypalFields');
    const cardFields = document.getElementById('cardFields');
    methodSelect.addEventListener('change', () => {
      if (methodSelect.value === 'paypal') {
        paypalFields.style.display = 'block';
        cardFields.style.display = 'none';
      } else {
        paypalFields.style.display = 'none';
        cardFields.style.display = 'block';
      }
    });
    (async function() {
      // verify session
      const { data: { session } } = await supabase.auth.getSession();
      if (!session || !session.user) {
        document.getElementById('authMessage').textContent = 'Please log in first.';
        document.getElementById('authMessage').style.display = 'block';
        document.getElementById('payoutForm').style.display = 'none';
        return;
      }
      currentUser = session.user;
      // prefill amount from query param
      const params = new URLSearchParams(window.location.search);
      const amt = params.get('amount');
      if (amt) {
        document.getElementById('amount').value = amt;
      }
    })();
    document.getElementById('payoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) return;
      const amtVal = parseFloat(document.getElementById('amount').value);
      const methodVal = document.getElementById('method').value;
      let details = {};
      if (methodVal === 'paypal') {
        const paypalEmail = document.getElementById('paypalEmail').value.trim();
        if (!paypalEmail) { alert('Please enter your PayPal email.'); return; }
        details.paypalEmail = paypalEmail;
      } else {
        const cardName = document.getElementById('cardName').value.trim();
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const cardExp = document.getElementById('cardExp').value.trim();
        const cardCVC = document.getElementById('cardCVC').value.trim();
        if (!cardName || !cardNumber || !cardExp || !cardCVC) { alert('Please complete all card details.'); return; }
        // Only store the last 4 digits for security
        details.cardName = cardName;
        details.cardLast4 = cardNumber.slice(-4);
        details.cardExp = cardExp;
      }
      try {
        const { error } = await supabase.from('payout_requests').insert({
          user_id: currentUser.id,
          amount: amtVal,
          method: methodVal,
          details,
          status: 'pending'
        });
        if (error) throw error;
        document.getElementById('payoutForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
      } catch (err) {
        console.error(err);
        alert('Error submitting payout request: ' + err.message);
      }
    });
  </script>
</body>
</html>